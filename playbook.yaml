---
# List of plays
-
  # Hosts: where our play will run and options it will run with
  hosts: localhost
  connection: local
  gather_facts: yes
  tags: always

  # Vars: variables that will apply to the play, on all targets 

  # Tasks: the list of tasks that will be executed within 
  #        the play, this section can also be used for 
  #        pre and post tasks
  tasks:
    # from https://superuser.com/questions/1395954/ansible-playbook-to-determine-os-release
  - name: System details
    debug: msg="{{ item }}"
    with_items: 
    - "{{ ansible_distribution }}"
    - "{{ ansible_distribution_version }}"
    - "{{ ansible_distribution_major_version }}"
    # Detect if we are running on a WSL2 environment
  - name: Set wsl2_environment fact default to false
    set_fact:
      wsl2_environment: false
  - name: Set wsl2_environment fact True
    set_fact:
      wsl2_environment: true
    when: ansible_kernel is search("microsoft-standard-WSL2")
  # fix for .gnupg/ permissions when building custom images
  - name: Add fix for .gnupg/ permissions
    lineinfile:
      path: "/etc/bash.bashrc"
      line: "chmod 700 ~/.gnupg/"    
  - name: Add custom prompt to /etc/skel/.profile
    lineinfile:
      path: "/etc/skel/.profile"
      line: 'export PS1="\[\033[00;32m\][\w]\$\[\033[00m\] "'

  # Handlers: the list of handlers that are executed as a notify 
  #           key from a task

  # Roles: list of roles to be imported into the play
  roles:
  - role: irixjp.role_example_hello

# Add additional plays here (remember the list entry -)
# Be sure to use the same hosts and connection entries above
# addtional plays

-
  # Install PharoLauncher
  hosts: localhost
  connection: local
  tags: install_pharolauncher

  tasks:
  - name: Download PharoLauncher (v3.0.1) zip file
    shell: wget https://files.pharo.org/pharo-launcher/3.0.1/PharoLauncher-linux-3.0.1-x64.zip
  - name: Unzip Pharo (v3.0.1) for 64-bit Linux
    unarchive:
      src: /home/kasm-default-profile/PharoLauncher-linux-3.0.1-x64.zip
      dest: /home/kasm-default-profile/
      remote_src: yes
  - name: Delete PharoLauncher zip file
    shell: rm /home/kasm-default-profile/PharoLauncher-linux-3.0.1-x64.zip

-
  # install GMAT
  hosts: localhost
  connection: local
  tasks:
  - name: Download GMAT tarball
    shell: wget https://sourceforge.net/projects/gmat/files/GMAT/GMAT-R2020a/gmat-ubuntu-x64-R2020a.tar.gz -O /home/kasm-default-profile/gmat-ubuntu-x64-R2020a.tar.gz
  - name: Extract GMAT tarball to /opt
    unarchive:
      src: /home/kasm-default-profile/gmat-ubuntu-x64-R2020a.tar.gz
      dest: /opt
      remote_src: yes
      creates: /opt/GMAT/R2020a/README.txt
  - name: Delete GMAT tarball
    shell: rm /home/kasm-default-profile/gmat-ubuntu-x64-R2020a.tar.gz

-
  # install Octave
  hosts: localhost
  connection: local
  tasks:
  - name: Install Octave with Apt
    apt:
      name: octave
      update_cache: yes
  - name: Install octave-doc with Apt
    apt:
      name: octave-doc
      update_cache: yes
  - name: Install octave-info with Apt
    apt:
      name: octave-info
      update_cache: yes
  - name: Install octave-htmldoc with Apt
    apt:
      name: octave-htmldoc
      update_cache: yes
  - name: Install liboctave-dev with Apt
    apt:
      name: liboctave-dev
      update_cache: yes
  - name: Install octave-control with Apt
    apt:
      name: octave-control
      update_cache: yes
  - name: Install octave-image with Apt
    apt:
      name: octave-image
      update_cache: yes
  - name: Install octave-io with Apt
    apt:
      name: octave-io
      update_cache: yes
  - name: Install octave-optim with Apt
    apt:
      name: octave-optim
      update_cache: yes
  - name: Install octave-signal with Apt
    apt:
      name: octave-signal
      update_cache: yes
  - name: Install octave-statistics with Apt
    apt:
      name: octave-statistics
      update_cache: yes

-
  # install Minicom from debian package
  hosts: localhost
  connection: local
  tasks:
  - name: Download Minicom debian package
    shell: wget http://launchpadlibrarian.net/458236105/minicom_2.7.1-1.1_amd64.deb -O /home/kasm-default-profile/minicom_2.7.1-1.1_amd64.deb
  - name: Install Minicom debian package
    shell: dpkg -i /home/kasm-default-profile/minicom_2.7.1-1.1_amd64.deb
  - name: Add USER to dialout group
    user:
      name: default
      shell: /bin/bash
      groups: "dialout"
      state: present
      remove: yes

-
  # Configure pulseaudio
  hosts: localhost
  connection: local
  tasks:
  - name: Apt install pulseaudio-utils with Apt
    apt:
      name: pulseaudio-utils
      update_cache: yes
  - name: Set up user attributes in /etc/passwd
    shell: echo "default:x:1000:1000:default User,,,:/home/default:/bin/bash" >> /etc/passwd
  - name: Connect to the host's server using the mounted UNIX socket
    shell: echo "default-server = unix:/run/user/1000/pulse/native" >> /etc/pulse/client.conf
  - name: Prevent the use of shared memory
    shell: echo "enable-shm = false" >> /etc/pulse/client.conf

-
  # install OpenJDK 11
  hosts: localhost
  connection: local
  tasks:
  - name: Download OpenJDK 11 tarball
    shell: wget https://download.java.net/openjdk/jdk11/ri/openjdk-11+28_linux-x64_bin.tar.gz -O /home/kasm-default-profile/openjdk-11+28_linux-x64_bin.tar.gz
  - name: Extract OpenJDK 11 binaries
    unarchive:
      src: /home/kasm-default-profile/openjdk-11+28_linux-x64_bin.tar.gz
      dest: /opt
      remote_src: yes
      creates: /opt/jdk-11/release
  - name: Delete OpenJDK 11 tarball
    shell: rm /home/kasm-default-profile/openjdk-11+28_linux-x64_bin.tar.gz
  - name: Update alternatives so the command, java, points to installed jdk
    shell: update-alternatives --install /usr/bin/java java /opt/jdk-11/bin/java 100
  - name: Update alternatives so the command, javac, points to installed jdk
    shell: update-alternatives --install /usr/bin/javac javac /opt/jdk-11/bin/javac 100

-
  # install Eclipse
  hosts: localhost
  connection: local
  tasks:
  - name: Download Eclipse IDE for Embedded C/C++ (2019-03 release) tarball
    shell: wget https://www.eclipse.org/downloads/download.php?file=/technology/epp/downloads/release/2019-03/R/eclipse-cpp-2019-03-R-linux-gtk-x86_64.tar.gz -O /home/kasm-default-profile/eclipse-cpp-2019-03-R-linux-gtk-x86_64.tar.gz
  - name: Unarchive Eclipse IDE for Embedded C/C++ (2019-03 release) tarball
    unarchive:
      src: /home/kasm-default-profile/eclipse-cpp-2019-03-R-linux-gtk-x86_64.tar.gz
      dest: /home/kasm-default-profile/
      remote_src: yes
  - name: Delete Eclipse IDE for Embedded C/C++ (2019-03 release) tarball
    shell: rm /home/kasm-default-profile/eclipse-cpp-2019-03-R-linux-gtk-x86_64.tar.gz
  - name: Create directory for eclipse/jre/
    shell: mkdir /home/kasm-default-profile/eclipse/jre/
  - name: Create directory for eclipse/jre/bin/
    shell: mkdir /home/kasm-default-profile/eclipse/jre/bin/
  - name: Create symlink to java binary
    shell: ln -sv /opt/jdk-11/bin/java /home/kasm-default-profile/eclipse/jre/bin/java
  - name: Export $HOME/eclipse/ to PATH
    shell: echo 'export PATH="$HOME/eclipse/:$PATH"' >> /home/kasm-default-profile/.bashrc

-
  # install chrome
  hosts: localhost
  connection: local
  gather_facts: yes

  roles:
    - role: webarchitect609.google_chrome

-
  # install keychain, git, and @capsulecorplab .vimrc and .gitconfig
  hosts: localhost
  connection: local
  gather_facts: yes
  tags: install_utilities

  vars:
    git_version: "2.36.1"
    git_version_to_install: "1:{{ git_version }}-0ppa1~ubuntu20.04.1"
    keychain_version: "2.8.5"
    keychain_version_to_install: "{{ keychain_version }}-1"
    keychain_version_expected: "{{ keychain_version }}.."

  tasks:
  - name: Install dh-autoreconf
    apt:
      name: dh-autoreconf
      update_cache: yes
  - name: Install libcurl4-gnutls-dev
    apt:
      name: libcurl4-gnutls-dev
      update_cache: yes
  - name: Install libexpat1-dev
    apt:
      name: libexpat1-dev
      update_cache: yes
  - name: Install gettext
    apt:
      name: gettext
      update_cache: yes
  - name: Install libz-dev
    apt:
      name: libz-dev
      update_cache: yes
  - name: Install libssl-dev
    apt:
      name: libssl-dev
      update_cache: yes
  - name: Install install-info
    apt:
      name: install-info
      update_cache: yes
  - name: Download git (v2.36.1) tarball
    shell: wget https://mirrors.edge.kernel.org/pub/software/scm/git/git-2.36.1.tar.gz -O /home/kasm-default-profile/git-2.36.1.tar.gz
  - name: Extract git source files
    unarchive:
      src: /home/kasm-default-profile/git-2.36.1.tar.gz
      dest: /home/kasm-default-profile/
      remote_src: yes
      creates: /home/kasm-default-profile/git-2.36.1/README.md
  - name: Delete git tarball
    shell: rm /home/kasm-default-profile/git-2.36.1.tar.gz
  - name: Build git
    shell:
      cmd: make configure && ./configure --prefix=/usr && make > /tmp/git_build_output.txt 2>&1 && make install
      chdir: /home/kasm-default-profile/git-2.36.1
      executable: /bin/bash
  - name: Delete git source files
    shell: rm -rf /home/kasm-default-profile/git-2.36.1
  - name: Install Keychain
    apt:
      name: "keychain={{ keychain_version_to_install }}"
      update_cache: yes
  - name: Get git version
    shell: git version | sed 's/[[:alpha:]|(|[:space:]]//g'
    register: installed_git_version
  - name: Get keychain version
    shell: 
      cmd: keychain -V 2> >(grep -i keychain) 2> >(sed 's/[[:alpha:]|(|[:space:]]//g') | fgrep '*' | sed 's/[*~://]//g'
      executable: /bin/bash
    register: installed_keychain_version
  - name: Display git and keychain versions
    debug:
      msg: "git = {{ installed_git_version.stdout }} | keychain = {{ installed_keychain_version.stdout }}"
  - name: Test git version
    fail:
      msg: "Git Version Error: Expected {{ git_version }} | Found {{ installed_git_version.stdout }}"
    when: installed_git_version.stdout != git_version  
  - name: Test keychain version
    fail:
      msg: "Keychain Version Error: Expected {{ keychain_version_expected }} | Found {{ installed_keychain_version.stdout }}"
    when: installed_keychain_version.stdout != keychain_version_expected
  - name: Install @capsulecorplab .vimrc
    get_url:
      url: https://gist.githubusercontent.com/capsulecorplab/495058e7a57ed8adaed3c40c80d09739/raw/4a6e6f6ff92b96919be111c9cbb5a4a21ab472d2/.vimrc
      dest: /home/kasm-default-profile/
  - name: Install @capsulecorplab .gitconfig
    get_url:
      url: https://gist.githubusercontent.com/capsulecorplab/401ba2fe0857a328f2a626adbf078cc6/raw/b89a6234f0d620ff60bcfe37f95de197b8772377/.gitconfig
      dest: /home/kasm-default-profile/

-
  # install Python packages with pip
  hosts: localhost
  connection: local
  gather_facts: yes

  tasks:
  - name: Update OS to point python to python3
    apt:
      name: python-is-python3
      update_cache: yes
  - name: Install pip for python3 with Apt
    apt:
      name: python3-pip
      update_cache: yes
  - name: Install python packages with pip
    pip:
      name:
        - jupyterlab
        - notebook
        - voila
        - pint
        - setuptools
        - bikeshed
  - name: Install fprime python packages & dependencies
    pip:
      requirements: https://raw.githubusercontent.com/nasa/fprime/v3.1.0/requirements.txt

-
  # install Git LFS
  hosts: localhost
  connection: local
  tasks:
  - name: Download Git LFS
    shell: wget https://github.com/git-lfs/git-lfs/releases/download/v3.1.2/git-lfs-linux-amd64-v3.1.2.tar.gz
  - name: Create directory for extracting Git LFS tarball
    shell: mkdir git-lfs-linux-amd64-v3.1.2
  - name: Extract Git LFS file contents
    shell: tar -xvf git-lfs-linux-amd64-v3.1.2.tar.gz -C git-lfs-linux-amd64-v3.1.2
  - name: Delete Git LFS tarball
    shell: rm git-lfs-linux-amd64-v3.1.2.tar.gz
  - name: Install Git LFS
    shell: ./git-lfs-linux-amd64-v3.1.2/install.sh
  - name: Delete Git LFS tarball directory
    shell: rm -rf git-lfs-linux-amd64-v3.1.2

-
  # install Cross-compile toolchain for embedded Linux target
  hosts: localhost
  connection: local
  tasks:
  - name: Install gcc-arm-linux-gnueabihf with Apt
    apt:
      name: gcc-arm-linux-gnueabihf
      update_cache: yes
  - name: Install g++-arm-linux-gnueabihf with Apt
    apt:
      name: g++-arm-linux-gnueabihf
      update_cache: yes
  - name: Install gdb-multiarch with Apt
    apt:
      name: gdb-multiarch
      update_cache: yes
  - name: Install build-essential with Apt
    apt:
      name: build-essential
      update_cache: yes
  - name: Download cmake tarball
    shell: wget http://www.cmake.org/files/v3.23/cmake-3.23.1.tar.gz -O /home/kasm-default-profile/cmake-3.23.1.tar.gz
  - name: Extract cmake source files
    unarchive:
      src: /home/kasm-default-profile/cmake-3.23.1.tar.gz
      dest: /home/kasm-default-profile/
      remote_src: yes
      creates: /home/kasm-default-profile/cmake-3.23.1/README
  - name: Delete cmake tarball
    shell: rm /home/kasm-default-profile/cmake-3.23.1.tar.gz
  - name: Build cmake
    shell:
      cmd: ./configure && make > /tmp/cmake_build_output.txt 2>&1 && make install
      chdir: /home/kasm-default-profile/cmake-3.23.1/
      executable: /bin/bash
  - name: Delete cmake source files
    shell: rm -rf /home/kasm-default-profile/cmake-3.23.1/

-
  # Install doctools
  hosts: localhost
  connection: local
  tags: install_doctools

  tasks:
  - name: Download ruby v3.1.2 source tarball
    shell: wget https://cache.ruby-lang.org/pub/ruby/3.1/ruby-3.1.2.tar.gz -O /home/kasm-default-profile/ruby-3.1.2.tar.gz
  - name: Extract ruby source tarball
    unarchive:
      src: /home/kasm-default-profile/ruby-3.1.2.tar.gz
      dest: /home/kasm-default-profile
      remote_src: yes
      creates: /home/kasm-default-profile/ruby-3.1.2
  - name: Delete ruby source tarball
    shell: rm -rf /home/kasm-default-profile/ruby-3.1.2.tar.gz
  - name: Build ruby
    shell:
      cmd: make configure && ./configure --prefix=/usr && make > /tmp/ruby_build_output.txt 2>&1 && make install
      chdir: /home/kasm-default-profile/ruby-3.1.2
      executable: /bin/bash
  - name: Delete ruby source files
    shell: rm -rf /home/kasm-default-profile/ruby-3.1.2
  - name: Download jabref deb
    shell: wget https://github.com/JabRef/jabref/releases/download/v5.6/jabref_5.6-1_amd64.deb -O /home/kasm-default-profile/jabref_5.6-1_amd64.deb
  - name: install jabref
    apt:
      deb: /home/kasm-default-profile/jabref_5.6-1_amd64.deb
      update_cache: yes
  - name: Delete jabref deb
    shell: rm /home/kasm-default-profile/jabref_5.6-1_amd64.deb
  - name: install zlib with Apt
    apt:
      name: zlib1g-dev
      update_cache: yes
  - name: install asciidoctor-bibtex as ruby gem
    shell: gem install asciidoctor-bibtex
  - name: install asciidoctor-diagram as ruby gem
    shell: gem install asciidoctor-diagram
  - name: install asciidoctor-pdf as ruby gem
    shell: gem install asciidoctor-pdf

-
  # install GPredict
  hosts: localhost
  connection: local
  tasks:
  - name: Install libtool
    apt:
      name: libtool
      update_cache: yes
  - name: Install intltool
    apt:
      name: intltool
      update_cache: yes
  - name: Install autoconf
    apt:
      name: autoconf
      update_cache: yes
  - name: Install automake
    apt:
      name: automake
      update_cache: yes
  - name: Install libcurl4-openssl-dev
    apt:
      name: libcurl4-openssl-dev
      update_cache: yes
  - name: Install pkg-config
    apt:
      name: pkg-config
      update_cache: yes
  - name: Install libglib2.0-dev
    apt:
      name: libglib2.0-dev
      update_cache: yes
  - name: Install libgtk-3-dev
    apt:
      name: libgtk-3-dev
      update_cache: yes
  - name: Install libgoocanvas-2.0-dev
    apt:
      name: libgoocanvas-2.0-dev
      update_cache: yes
  - name: Download GPredict tarball
    shell: wget https://github.com/csete/gpredict/releases/download/v2.2.1/gpredict-2.2.1.tar.bz2 -O /home/kasm-default-profile/gpredict-2.2.1.tar.bz2
  - name: Extract GPredict source files
    unarchive:
      src: /home/kasm-default-profile/gpredict-2.2.1.tar.bz2
      dest: /home/kasm-default-profile/
      remote_src: yes
      creates: /home/kasm-default-profile/gpredict-2.2.1/README
  - name: Delete GPredict tarball
    shell: rm /home/kasm-default-profile/gpredict-2.2.1.tar.bz2
  - name: Build GPredict
    shell:
      cmd: ./configure && make > /tmp/gpredict_build_output.txt 2>&1 && make install
      chdir: /home/kasm-default-profile/gpredict-2.2.1/
      executable: /bin/bash
  - name: Delete GPredict source files
    shell: rm -rf /home/kasm-default-profile/gpredict-2.2.1/

-
  # install GNU Radio Software with Apt
  hosts: localhost
  connection: local
  tasks:
  - name: Add PPA repository for GNU Radio v3.8
    shell: add-apt-repository ppa:gnuradio/gnuradio-releases-3.8
  - name: Apt install GNU Radio v3.8 with Apt
    apt:
      name: gnuradio
      update_cache: yes

- 
  # install sudo for the vs-code role below 
  hosts: localhost
  connection: local
  tasks:
  - name: Install Sudo
    apt:
      name: sudo
      update_cache: yes
  - name: Preserve DONT_PROMPT_WSL_INSTALL in sudoers
    lineinfile:
      path: "/etc/sudoers"
      line: "Defaults        env_keep += \"DONT_PROMPT_WSL_INSTALL\""
    when: wsl2_environment

-
# add dev user to give vs code somewhere to install extensions
  hosts: localhost
  connection: local
  tasks:
  - name: Add dev user
    user:
      name: dev
      uid: 1001

-
  # install the remainder of the tools
  hosts: localhost
  connection: local
  environment: 
    DONT_PROMPT_WSL_INSTALL: 1
  roles:
    - role: gantsign.visual-studio-code
      users:
        - username: "dev"
          visual_studio_code_extensions:
            - ms-python.python
          visual_studio_code_settings_overwrite: yes
          visual_studio_code_settings: {
            "extensions.ignoreRecommendations": true,
            "update.mode": "none",
            "extensions.autoUpdate": false,
            "extensions.autoCheckUpdates": false,
            "terminal.integrated.profiles.linux": {
              "bash (login)": {
                "path": "bash",
                "args": ["-l"]
                }
              },
            "terminal.integrated.defaultProfile.linux": "bash (login)" 
          }  

-
  # Copy VS Code changes to kasm-default-profile and lean up (remove) dev user now that vs code is installed
  hosts: localhost
  connection: local
  tasks:
  - name: Copy VS Code changes to kasm-default-profile
    shell: 
      cmd: cp -r /home/dev/.config/Code/ /home/kasm-default-profile/.config/Code/ && cp -r /home/dev/.vscode/ /home/kasm-default-profile/.vscode/
  - name: Remove dev user
    user:
      name: dev
      state: absent
      remove: yes 

-
  # Install OML Tools
  hosts: localhost
  connection: local
  tags: install_oml

  tasks:
  - name: Download Rosetta 1.3.1 zip file for linux x86_64
    shell: wget https://github.com/opencaesar/oml-rosetta/releases/download/1.3.1/rosetta-1.3.1-linux.gtk.x86_64.zip
  - name: Unzip Rosetta RCP
    unarchive:
      src: /home/kasm-default-profile/rosetta-1.3.1-linux.gtk.x86_64.zip
      dest: /usr/local/bin
      remote_src: yes
  - name: Delete Rosetta zip file
    shell: rm rosetta-1.3.1-linux.gtk.x86_64.zip
  - name: symlink Rosetta executable into /usr/local/bin/
    file:
      src: /usr/local/bin/Rosetta/Rosetta
      dest: /usr/local/bin/rosetta
      owner: root
      group: root
      state: link
  - name: Install R helper packages
    apt:
      name: software-properties-common, dirmngr
      update_cache: yes
      install_recommends: no
  - name: Install OML tutorials R dependencies
    apt:
      name: libxml2-dev, libcurl4-openssl-dev, libssl-dev, gfortran, libblas-dev, liblapack-dev
      update_cache: yes
  - name: Add R repos signing key
    shell:
      cmd: wget -qO- https://cloud.r-project.org/bin/linux/ubuntu/marutter_pubkey.asc | tee -a /etc/apt/trusted.gpg.d/cran_ubuntu_key.asc
  - name: Add the R 4.0 repo from CRAN
    shell:
      cmd: add-apt-repository "deb https://cloud.r-project.org/bin/linux/ubuntu $(lsb_release -cs)-cran40/"
  - name: Install R
    apt:
      name: r-base
      update_cache: yes
      install_recommends: no
  - name: Download R Studio deb file
    shell: wget https://download1.rstudio.org/desktop/bionic/amd64/rstudio-2022.07.1-554-amd64.deb
  - name: Install R Studio
    apt:
      deb: /home/kasm-default-profile/rstudio-2022.07.1-554-amd64.deb
      update_cache: yes
  - name: Delete R Studio file
    shell: rm rstudio-2022.07.1-554-amd64.deb
  - name: Add Stardog aptkey
    shell:
      cmd: curl http://packages.stardog.com/stardog.gpg.pub | apt-key add
  - name: Add stardog repo
    shell:
      cmd: echo "deb http://packages.stardog.com/deb/ stable main" >> /etc/apt/sources.list
  - name: Install stardog
    apt:
      name: stardog
      update_cache: yes
      install_recommends: yes

# Three dots indicate the end of a YAML document
...
